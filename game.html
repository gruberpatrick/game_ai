<!DOCTYPE html>
<html>

    <head>
        <title>Tic Tac Toe</title>
        <style type="text/css">
            body{background:#000;color:#fff;padding:0;margin:0;}
            #board{padding:20px;}
            .board_buttons{width:40px;height:40px;background:#333;color:#fff;border:1px solid #ccc;font-weight:bold;}
            #players{padding:20px;}
            #controls{padding:20px;}
        </style>
    </head>

    <body>

        <div id="players"></div>
        <div id="board">

        </div>
        <div id="controls">
            <button id="hist_back"><- back in time</button>
            <button id="hist_forward">forward -></button>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
        <script type="text/javascript">

            var ws = new WebSocket("ws://localhost:8765");
            var conn_opened = false;
            var board_history = [];
            var hist_pointer = null;

            var message_queue = [
                "ap X MM",
                "ap O",
                "sp",
                "s"
            ];

            $("#hist_back").bind("click", function(e){
                if(hist_pointer == null) hist_pointer = board_history.length - 1;
                hist_pointer--;
                showBoard(board_history[hist_pointer])
            });

            $("#hist_forward").bind("click", function(e){
                if(hist_pointer == null) hist_pointer = 0;
                hist_pointer++;
                showBoard(board_history[hist_pointer])
            });

            ws.onopen = function(e){
                conn_opened = true;
                sendMessageQueue();
            };

            ws.onmessage = function(event){
                message = event.data;
                data = JSON.parse(message);
                if(data["type"] == "board") showBoard(data["message"]);
                if(data["type"] == "players") showPlayers(data["message"]);
                if(data["message"] == "10-4"){
                    console.log("sending next message...")
                    sendMessageQueue();
                }
            };

            function showPlayers(players){
                $("#players").html(players);
            }

            function showBoard(board){
                if(board_history[board_history.length - 1] != board)
                    board_history.push(board);
                $("#board").html("");
                var lines = board.split("\n")
                for(var it in lines){
                    var row = "<div>";
                    var cells = lines[it].split("\t");
                    for(var jt in cells){
                        if(cells[jt] != "") row += "<button class=\"board_buttons\" data-coord=\"" + jt + " " + it + "\">" + cells[jt] + "</button>";
                    }
                    $("#board").append(row + "</div>");
                }
                $(".board_buttons").bind("click", function(){
                    var value = $(this).attr("data-coord");
                    sendMessage(value);
                });
            }

            function sendMessage(message){
                ws.send(message);
            }

            function sendMessageQueue(){
                if(message_queue.length == 0) return;
                message = message_queue[0];
                console.log("sending", message)
                message_queue.shift();
                sendMessage(message);
            }

        </script>

    </body>

</html>